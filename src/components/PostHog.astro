---
// See the framework guide here: https://posthog.com/docs/libraries/astro
---

<script>
  import posthog from 'posthog-js';
  
  const posthogKey = 'phc_bXFVKWRZnEDUWbXQf3VjlAHeemyJDSsTqkpvDINHGFG';
  const posthogUrl = 'https://us.i.posthog.com';
  
  const hashParams = new URLSearchParams(window.location.hash.substring(1));
  const distinct_id = hashParams.get('distinct_id');
  const session_id = hashParams.get('session_id');

  const config = {
    api_host: posthogUrl,
    cross_subdomain_cookie: true,
  };

  if (distinct_id || session_id) {
    config.bootstrap = {
      distinctID: distinct_id,
      sessionID: session_id
    };
  }

  posthog.init(posthogKey, config);

  if (window.location.hash && (distinct_id || session_id)) {
    window.history.replaceState(null, '', window.location.pathname + window.location.search);
  }

  document.addEventListener('click', (event) => {
    const link = event.target.closest('a');
    if (!link || !link.href) return;

    try {
      const url = new URL(link.href);
      const currentDomain = window.location.hostname;

      if (url.hostname !== currentDomain) {
        const distinctId = posthog.get_distinct_id();
        const sessionId = posthog.get_session_id();

        if (distinctId || sessionId) {
          event.preventDefault();

          const hashParams = new URLSearchParams();
          if (distinctId) hashParams.set('distinct_id', distinctId);
          if (sessionId) hashParams.set('session_id', sessionId);

          const trackedUrl = `${link.href}${link.href.includes('#') ? '&' : '#'}${hashParams.toString()}`;

          if (link.target === '_blank' || event.ctrlKey || event.metaKey) {
            window.open(trackedUrl, '_blank');
          } else {
            window.location.href = trackedUrl;
          }
        }
      }
    } catch {
    }
  });
</script>
